#!/usr/bin/env bash

set -euo pipefail

iam_usage() {
	echo 'usage: iam (starting) [JIRA_ID]' 1>&2
	exit 1
}

iam_starting() {
	local jira_id="$2"

	if [[ $( git status --porcelain | grep -v \^?? | wc -l ) -gt 0 ]]; then
		echo 'error: your Git working tree is not clean, you may lose your changes, aborting.' 1>&2
		exit 2
	fi

	git checkout develop --quiet
	git pull --rebase --quiet

	git checkout -b "$jira_id"-"$( echo "${@:3}" | iconv -t ascii//TRANSLIT | sed -r 's/[^a-zA-Z0-9]+/-/g' | sed -r 's/^-+\|-+$//g' | tr A-Z a-z )" --quiet

	watson start "$jira_id"
}

iam_finished() {
	if [[ $( git status --porcelain | grep -v \^?? | wc -l ) -gt 0 ]]; then
		echo 'error: your Git working tree is not clean, you may lose your changes, aborting.' 1>&2
		exit 2
	fi

	git checkout develop --quiet
	git fetch origin --prune --verbose
	git pull --rebase

	watson stop
}

"iam_${1-usage}" "$@"
