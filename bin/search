#!/usr/bin/env bash

set -e
set -o pipefail

search() {
  local search_locale
  local search_query
  local search_path
  local search_args
  local method
  local temporary

  if [ $# -lt 1 ]; then
    echo 'Usage: '"$( basename "$0" )"' PATTERN [+EXTENSION...] [-EXTENSION...] [!DIRECTORY...] [PATH] [OPTIONS...]' 1>&2
    return 1
  fi

  # Query always comes first.
  search_query="$1"
  shift

  # If any of the following arguments starts with a '+' or '-',
  # it is considered an include/exclude extension.
  while [[ "$1" =~ ^[!+\-][^\-] ]]; do
    case "${1:0:1}" in
      !)
        argument="--exclude-dir='${1:1}'"
        ;;
      +)
        argument="--include='*.${1:1}'"
        ;;
      -)
        argument="--exclude='*.${1:1}'"
        ;;
    esac
    search_args="${search_args} ${argument}"
    shift
  done

  # If we are in Vim, don't use color and print line numbers for each match.
  if [ -n "$VIM" ]; then
    search_args="${search_args} --color=never -n"
  fi

  # Directory (path) to search always comes last.
  # The current working directory is stripped to shorten file paths in output.
  if [ $# -gt 0 ]; then
    search_path="$1"
    if [ ! -d "$search_path" ]; then
      echo "$( basename "$0" ): no such directory: ${search_path}" 1>&2
      return 2
    fi
    shift
  else
    search_path="${PWD}"
  fi
  search_path="${search_path/#${PWD}/.}"

  # > Using LC_CTYPE=POSIX instead of UTF-8 speeds up my grep by a factor of 27.
  # > Log file greppers of the world, take note.
  #
  # https://twitter.com/jlaurila/status/86750682094374912
  temporary="$( mktemp -t detect-XXXXXXXX )"
  echo "$search_query" > "$temporary"
  if file -bi "$temporary" | grep -qi 'ascii'; then
    search_locale='LC_CTYPE=POSIX'
  else
    search_locale=''
  fi
  rm -f "$temporary"

  eval "$search_locale"         \
  grep -Ri                      \
    --color=always              \
    --line-number               \
    --binary-file=without-match \
    --no-messages               \
    --extended-regexp           \
        --exclude='.tags'       \
    --exclude-dir='.git'        \
    --exclude-dir='.hg'         \
    --exclude-dir='.svn'        \
    --exclude-dir='.sass-cache' \
    "$search_args"              \
    \"\$@\"                     \
    \"\$search_query\"          \
    \"\${search_path}\"         \
  | less -iRSg
}

search "$@"
